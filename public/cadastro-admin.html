
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de Admin de Empresa</title>
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(120deg, #4f8cff 0%, #a3bffa 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    .container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(44,62,80,0.15);
      padding: 32px 32px 24px 32px;
      max-width: 400px;
      width: 100%;
      margin: 40px 0;
      animation: fadeIn 0.7s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      text-align: center;
      margin-bottom: 24px;
      color: #3264d6;
      letter-spacing: 1px;
    }
    label {
      margin-top: 14px;
      color: #333;
      font-weight: 500;
    }
    select, input {
      width: 100%;
      padding: 10px 12px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafe;
      font-size: 15px;
      transition: border 0.2s;
    }
    select:focus, input:focus {
      outline: none;
      border: 1.5px solid #4f8cff;
      background: #fff;
    }
    button {
      width: 100%;
      margin-top: 24px;
      padding: 12px 0;
      background: linear-gradient(90deg, #4f8cff 0%, #3264d6 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 4px 16px rgba(44,62,80,0.07);
    }
    button:hover {
      background: linear-gradient(90deg, #3264d6 0%, #4f8cff 100%);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .msg {
      margin-top: 22px;
      font-weight: bold;
      text-align: center;
      font-size: 15px;
    }
    .success {
      color: #22c55e;
    }
    .error {
      color: #ef4444;
    }
    .loading {
      color: #6b7280;
    }
    @media (max-width: 500px) {
      .container {
        padding: 18px 8px 10px 8px;
      }
    }
  </style>
</head>
  <body>
    <div class="container">
      <h2>Cadastro de Administrador de Empresa</h2>
      <form id="adminForm" autocomplete="off">
        <label for="empresa">Empresa</label>
        <select id="empresa" name="empresa_id" required>
          <option value="">Selecione uma empresa...</option>
        </select>
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" required placeholder="Nome completo">
        <label for="email">E-mail</label>
        <input type="email" id="email" name="email" required placeholder="email@empresa.com">
        <label for="senha">Senha</label>
        <input type="password" id="senha" name="senha" required minlength="6" autocomplete="new-password" placeholder="M√≠nimo 6 caracteres">
        <label for="senha2">Confirme a senha</label>
        <input type="password" id="senha2" name="senha2" required minlength="6" autocomplete="new-password" placeholder="Repita a senha">
        <button type="submit" id="submitBtn">Cadastrar</button>
      </form>
      <div class="msg" id="msg"></div>
    </div>

    <!-- Inclua o client JS do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
      // Configura√ß√£o do Supabase
      const supabaseUrl = 'https://nfwdgkjrkmrjsfnbmsrd.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5md2Rna2pya21yanNmbmJtc3JkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNDQwMTgsImV4cCI6MjA2NDYyMDAxOH0.3j7kaUxWr8jYMBy28qtDCp8ZLxs1Fgj2aBOcY9kPHYo';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      const msgElement = document.getElementById('msg');
      const submitBtn = document.getElementById('submitBtn');

      function showMessage(message, type = 'loading') {
        msgElement.textContent = message;
        msgElement.className = `msg ${type}`;
      }

      function setLoading(loading) {
        submitBtn.disabled = loading;
        submitBtn.textContent = loading ? 'Cadastrando...' : 'Cadastrar';
      }

      // Carrega empresas no dropdown
      async function carregarEmpresas() {
        console.log('üîÑ Carregando empresas...');
        const select = document.getElementById('empresa');
        select.innerHTML = '<option value="">Carregando empresas...</option>';
        
        try {
          const { data, error } = await supabase
            .from('empresas')
            .select('id, nome')
            .eq('status', 'ativo')
            .order('nome');

          if (error) {
            console.error('‚ùå Erro ao carregar empresas:', error);
            showMessage('Erro ao carregar empresas', 'error');
            select.innerHTML = '<option value="">Erro ao carregar empresas</option>';
            return;
          }

          console.log(`‚úÖ ${data.length} empresas carregadas`);
          select.innerHTML = '<option value="">Selecione uma empresa...</option>';
          
          data.forEach(emp => {
            const opt = document.createElement('option');
            opt.value = emp.id;
            opt.textContent = emp.nome;
            select.appendChild(opt);
          });
        } catch (error) {
          console.error('üí• Erro inesperado ao carregar empresas:', error);
          showMessage('Erro de conex√£o ao carregar empresas', 'error');
          select.innerHTML = '<option value="">Erro de conex√£o</option>';
        }
      }

      // Chamar Edge Function para cadastro
      async function cadastrarAdmin(dadosAdmin) {
        console.log('üöÄ Enviando dados para Edge Function...');
        
        try {
          const response = await fetch(`${supabaseUrl}/functions/v1/cadastro-admin-empresa`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${supabaseKey}`,
            },
            body: JSON.stringify(dadosAdmin),
          });

          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.error || 'Erro na requisi√ß√£o');
          }

          return { data: result, error: null };
        } catch (error) {
          console.error('‚ùå Erro na Edge Function:', error);
          return { data: null, error };
        }
      }

      // Formul√°rio de cadastro
      document.getElementById('adminForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const empresa_id = document.getElementById('empresa').value;
        const nome = document.getElementById('nome').value.trim();
        const email = document.getElementById('email').value.trim();
        const senha = document.getElementById('senha').value;
        const senha2 = document.getElementById('senha2').value;

        // Valida√ß√µes client-side
        if (!empresa_id) {
          showMessage('Selecione uma empresa', 'error');
          return;
        }

        if (!nome || nome.length < 2) {
          showMessage('Nome deve ter pelo menos 2 caracteres', 'error');
          return;
        }

        if (!email || !email.includes('@')) {
          showMessage('Email inv√°lido', 'error');
          return;
        }

        if (senha !== senha2) {
          showMessage('As senhas n√£o coincidem!', 'error');
          return;
        }

        if (senha.length < 6) {
          showMessage('Senha deve ter pelo menos 6 caracteres', 'error');
          return;
        }

        setLoading(true);
        showMessage('Enviando dados...', 'loading');

        try {
          const { data, error } = await cadastrarAdmin({
            empresa_id,
            nome,
            email,
            senha
          });

          if (error) {
            showMessage(error.message || 'Erro ao cadastrar administrador', 'error');
            return;
          }

          showMessage(data.message || 'Administrador cadastrado com sucesso!', 'success');
          document.getElementById('adminForm').reset();
          
          // Opcional: redirecionar ap√≥s sucesso
          setTimeout(() => {
            if (confirm('Cadastro realizado com sucesso! Deseja ir para a p√°gina de login?')) {
              window.location.href = '/';
            }
          }, 2000);

        } catch (error) {
          console.error('üí• Erro inesperado:', error);
          showMessage('Erro de conex√£o. Tente novamente.', 'error');
        } finally {
          setLoading(false);
        }
      };

      // Inicializar
      document.addEventListener('DOMContentLoaded', () => {
        carregarEmpresas();
      });
    </script>
  </body>
</html>
